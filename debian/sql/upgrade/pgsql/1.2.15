-- Upgrade from v1.2.10 to v1.2.15
-- Fix trigger

BEGIN;

CREATE OR REPLACE FUNCTION log_metadata() RETURNS TRIGGER AS $body$
    BEGIN
        IF TG_OP = 'UPDATE' AND OLD.type != NEW.type THEN
            RAISE EXCEPTION 'type of metadata should not be modified' USING ERRCODE = '09000';
        ELSIF TG_OP = 'DELETE' OR OLD != NEW THEN
            INSERT INTO MetadataLog(id, type, key, value, login, updated)
                VALUES (OLD.id, OLD.type, OLD.key, OLD.value, OLD.login, TG_OP == 'UPDATE');
        END IF;
        RETURN NEW;
    END;
$body$ LANGUAGE plpgsql;

UPDATE MetadataLog SET updated = NOT updated;

COMMIT;

