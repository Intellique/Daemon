-- Upgrade from v1.3.8 to v1.3.9

BEGIN;

CREATE TYPE ArchiveStatus AS ENUM (
    'incomplete',
    'data-complete',
    'complete',
    'error'
);

ALTER TABLE archive RENAME COLUMN deleted TO old_deleted;
ALTER TABLE archive ADD COLUMN status ArchiveStatus, ADD COLUMN deleted BOOLEAN NOT NULL DEFAULT FALSE;
UPDATE archive SET status = 'complete', deleted = old_deleted;
ALTER TABLE archive DROP COLUMN old_deleted, ALTER COLUMN status SET NOT NULL;

ALTER TABLE archivevolume ALTER COLUMN endtime DROP NOT NULL;


DROP MATERIALIZED VIEW IF EXISTS milestones_files;
CREATE MATERIALIZED VIEW milestones_files AS
SELECT sa.id AS archive, sa.archive_name, sa.archive_size, sa.starttime AS archive_starttime, sa.endtime AS archive_endtime,
    af.id AS archivefile, af.name, "substring"(af.name, char_length("substring"(af.name, '(.+/)[^/]+'::text)) + 1) AS file_name,
    af.type, af.mimetype, af.ctime AS file_ctime, af.mtime AS file_mtime, af.size AS file_size, af.owner AS file_owner,
    af.name = sf.path AS file_isroot, ('['::text || array_to_string(saf.medias, ','::text)) || ']'::text AS medias,
    saf.medias_length, sp.id AS pool, sp.name AS pool_name
FROM archivefile af
    JOIN (
        SELECT afv.archivefile, av.archive, array_agg(('"'::text || COALESCE(m.name, m.label, m.mediumserialnumber)::text) || '"'::text) AS medias,
                max(char_length(COALESCE(m.name, m.label, m.mediumserialnumber)::text)) AS medias_length, m.pool
        FROM archivefiletoarchivevolume afv
            JOIN archivevolume av ON afv.archivevolume = av.id
            JOIN media m ON av.media = m.id
        GROUP BY afv.archivefile, av.archive, m.pool
    ) saf ON af.id = saf.archivefile
    JOIN (
        SELECT a.id, a.name AS archive_name, sum(av.size) AS archive_size, min(av.starttime) AS starttime, max(av.endtime) AS endtime
        FROM archive a
            JOIN archivevolume av ON a.id = av.archive
        GROUP BY a.id, a.name
    ) sa ON saf.archive = sa.id
    JOIN pool sp ON saf.pool = sp.id
    JOIN selectedfile sf ON af.parent = sf.id;
CREATE UNIQUE INDEX ON milestones_files(archive, archivefile);

COMMIT;

